<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="images/favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parking Fine Appeal Letter | Quaerens</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .goog-te-banner-frame.skiptranslate, .goog-te-gadget-icon, .goog-logo-link, .goog-te-gadget, body > .skiptranslate {
      display: none !important;
    }
    .goog-te-gadget { font-size: 0 !important; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div id="google_translate_element" style="display: none;"></div>
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="/"><img src="images/logo-parkingtemp.png" alt="Quaerens Logo" class="h-20 w-auto" /></a>
      <nav>
        <div class="w-full bg-gray-100 text-right p-2">
          <div x-data="{ open: false }" class="relative inline-block text-left">
            <button @click="open = !open"
              class="inline-flex items-center justify-center rounded border border-gray-300 px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none">
              🌐 Language
              <svg class="ml-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8l5 5 5-5" />
              </svg>
            </button>
            <div x-show="open" @click.outside="open = false"
              class="absolute right-0 mt-2 w-48 rounded-md shadow bg-white text-sm text-gray-700 z-50">
              <a href="#" onclick="setLanguage('en|en')" class="block px-4 py-2 hover:bg-gray-100">🇬🇧 English</a>
              <a href="#" onclick="setLanguage('en|fr')" class="block px-4 py-2 hover:bg-gray-100">🇫🇷 Français</a>
              <a href="#" onclick="setLanguage('en|es')" class="block px-4 py-2 hover:bg-gray-100">🇪🇸 Español</a>
              <a href="#" onclick="setLanguage('en|de')" class="block px-4 py-2 hover:bg-gray-100">🇩🇪 Deutsch</a>
              <a href="#" onclick="setLanguage('en|it')" class="block px-4 py-2 hover:bg-gray-100">🇮🇹 Italiano</a>
              <a href="#" onclick="setLanguage('en|nl')" class="block px-4 py-2 hover:bg-gray-100">🇳🇱 Nederlands</a>
              <a href="#" onclick="setLanguage('en|sv')" class="block px-4 py-2 hover:bg-gray-100">🇸🇪 Svenska</a>
              <a href="#" onclick="setLanguage('en|da')" class="block px-4 py-2 hover:bg-gray-100">🇩🇰 Dansk</a>
              <a href="#" onclick="setLanguage('en|pl')" class="block px-4 py-2 hover:bg-gray-100">🇵🇱 Polski</a>
              <a href="#" onclick="setLanguage('en|cs')" class="block px-4 py-2 hover:bg-gray-100">🇨🇿 Čeština</a>
              <a href="#" onclick="setLanguage('en|ro')" class="block px-4 py-2 hover:bg-gray-100">🇷🇴 Română</a>
              <a href="#" onclick="setLanguage('en|bg')" class="block px-4 py-2 hover:bg-gray-100">🇧🇬 Български</a>
              <a href="#" onclick="setLanguage('en|el')" class="block px-4 py-2 hover:bg-gray-100">🇬🇷 Ελληνικά</a>
              <a href="#" onclick="setLanguage('en|pt')" class="block px-4 py-2 hover:bg-gray-100">🇵🇹 Português</a>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="relative w-full overflow-hidden">
    <img src="images/hero-parking2.png" alt="Parking Appeal Banner"
      class="w-full h-auto object-cover object-center" loading="eager" fetchpriority="high" />
  </section>

  <div class="max-w-3xl mx-auto px-4 mt-12 mb-8" data-aos="fade-up">
    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-900 p-6 rounded-xl shadow text-left">
      <h3 class="text-lg font-bold mb-3">How This Works – It's 100% Free</h3>
      <ul class="space-y-3 text-sm sm:text-base">
        <li class="flex items-start gap-2"><span class="text-green-600 mt-1">✔</span>
          <span>Fill in your parking fine and appeal details; we’ll generate your appeal letter <strong>completely FREE!</strong>.</span>
        </li>
        <li class="flex items-start gap-2"><span class="text-green-600 mt-1">✔</span>
          <span>Email or print the PDF we provide, then send it to the council or parking operator.</span>
        </li>
        <li class="flex items-start gap-2"><span class="text-green-600 mt-1">✔</span>
          <span>Wait for a decision—no commission, no hidden costs.</span>
        </li>
        <li class="flex items-start gap-2"><span class="text-green-600 mt-1">✔</span>
          <span>If you like our free service, please recommend us to others. 😊</span>
        </li>
      </ul>
    </div>

    <form id="claim-letter-form" class="space-y-6 mt-8 bg-white p-8 rounded-xl shadow" enctype="multipart/form-data" novalidate>
      <div>
        <label for="fullName" class="block text-sm font-semibold text-gray-700">Full Name *</label>
        <input type="text" id="fullName" name="fullName" required class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <p class="text-xs text-gray-500 mt-1">Enter your name as on the PCN or ticket.</p>
      </div>
      <div>
        <label for="email" class="block text-sm font-semibold text-gray-700">Email Address *</label>
        <input type="email" id="email" name="email" required class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <p class="text-xs text-gray-500 mt-1">We’ll send your appeal PDF to this address.</p>
      </div>
      <div>
        <label for="phone" class="block text-sm font-semibold text-gray-700">Phone Number</label>
        <input type="tel" id="phone" name="phone" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <p class="text-xs text-gray-500 mt-1">Optional, for urgent queries only.</p>
      </div>
      <div>
        <label for="ticketNumber" class="block text-sm font-semibold text-gray-700">PCN / Ticket Number</label>
        <input type="text" id="ticketNumber" name="ticketNumber" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <p class="text-xs text-gray-500 mt-1">As shown on your penalty charge or parking notice.</p>
      </div>
      <div>
        <label for="provider" class="block text-sm font-semibold text-gray-700">Parking Authority / Operator *</label>
        <input type="text" id="provider" name="provider" required class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <p class="text-xs text-gray-500 mt-1">E.g. Local council, private parking company, etc.</p>
      </div>
      <div>
        <label for="dateIssued" class="block text-sm font-semibold text-gray-700">Date Issued</label>
        <input type="date" id="dateIssued" name="dateIssued" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label for="vehicleReg" class="block text-sm font-semibold text-gray-700">Vehicle Registration</label>
        <input type="text" id="vehicleReg" name="vehicleReg" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label for="claimType" class="block text-sm font-semibold text-gray-700">Reason for Appeal *</label>
        <select id="claimType" name="claimType" required class="w-full border border-gray-300 rounded-md p-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="" disabled selected>Select reason</option>
          <option value="signage">Unclear/missing signage</option>
          <option value="emergency">Medical/emergency situation</option>
          <option value="machine">Payment machine not working</option>
          <option value="error">Incorrect details on ticket</option>
          <option value="mitigating">Mitigating/personal circumstances</option>
          <option value="other">Other (explain below)</option>
        </select>
      </div>
      <div>
        <label for="issueDescription" class="block text-sm font-semibold text-gray-700">Describe the Issue *</label>
        <textarea id="issueDescription" name="issueDescription" rows="4" required class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
        <p class="text-xs text-gray-500 mt-1">Give full details—what happened, location, why you believe the fine is unfair, and any evidence.</p>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Tick the evidence you can provide:</label>
        <div class="flex flex-col gap-2 pl-1">
          <label><input type="checkbox" name="evidence" value="Photos" class="mr-2">Photos of signage/location</label>
          <label><input type="checkbox" name="evidence" value="Ticket/PCN" class="mr-2">Copy of PCN/ticket</label>
          <label><input type="checkbox" name="evidence" value="Receipts" class="mr-2">Receipts/payment records</label>
          <label><input type="checkbox" name="evidence" value="Medical" class="mr-2">Medical or emergency proof</label>
          <label><input type="checkbox" name="evidence" value="Correspondence" class="mr-2">Correspondence with authority</label>
          <label>
            <input type="checkbox" name="evidence" value="Other" class="mr-2" id="evidenceOtherCheckbox">
            Other relevant documents
          </label>
          <input type="text" id="evidenceOtherText" name="evidenceOtherText"
                 class="mt-2 p-2 border border-gray-300 rounded w-full text-sm"
                 placeholder="Please specify other evidence"
                 style="display:none;" />
        </div>
        <p class="text-xs text-gray-500 mt-2">Tick all that apply. Mention or upload these if asked by the council/operator.</p>
      </div>
      <div>
        <label for="preferredContact" class="block text-sm font-semibold text-gray-700">Preferred Contact Method</label>
        <select id="preferredContact" name="preferredContact" class="w-full border border-gray-300 rounded-md p-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="email">Email</option>
          <option value="phone">Phone</option>
        </select>
      </div>
      <div>
        <label for="donation" class="block text-sm font-semibold text-gray-700">Donation (optional)</label>
        <select id="donation" name="donation" class="w-full border border-gray-300 rounded-md p-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="0" selected>None</option>
          <option value="5">€5</option>
          <option value="10">€10</option>
          <option value="20">€20</option>
        </select>
      </div>
      <div class="text-center pt-4">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition">
          Submit My Parking Appeal
        </button>
      </div>
      <div id="claim-letter-result" class="hidden mt-6 text-green-700 font-semibold text-center">
        ✅ Your appeal has been submitted. We’ll be in touch soon.
      </div>
    </form>
  </div>

  <footer class="bg-blue-900 text-white text-center py-6 w-full">
    <p class="mb-2">© 2025 Quaerens Ltd. All rights reserved.</p>
    <p>
      <a href="#" class="underline">Privacy Policy</a> |
      <a href="#" class="underline">Terms of Use</a> |
      <a href="#" class="underline">GDPR</a> |
      <a href="#" class="underline">Contact Us</a>
    </p>
  </footer>

  <script type="module" src="firebase-setup.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', async () => {
  // Prefill fields from query params
  const params = new URLSearchParams(window.location.search);
  const prefillFields = [
    "claimType", "fullName", "email", "phone",
    "ticketNumber", "provider", "dateIssued", "vehicleReg"
  ];
  prefillFields.forEach(f => {
    if (params.has(f)) {
      const el = document.getElementById(f);
      if (el) el.value = params.get(f);
    }
  });

  const form = document.getElementById("claim-letter-form");
  const resultDiv = document.getElementById("claim-letter-result");

  // LEGAL JUSTIFICATION for parking appeals
  const legalJustification = {
    signage: `Under the Traffic Management Act 2004 (UK) and equivalent regulations, all parking restrictions must be clearly signed and marked. If signage is missing, unclear, or contradictory, a penalty charge may be invalid and should be cancelled.`,
    emergency: `In cases of genuine emergency or medical need, enforcement authorities have discretion to cancel fines—especially if you provide supporting evidence and acted reasonably.`,
    machine: `If the payment machine was out of order and you took reasonable steps to pay, you should not be penalised. Keep photos or witness evidence where possible.`,
    error: `If the penalty notice contains incorrect information—such as your registration, date, location, or reason—it may be unenforceable and can be challenged.`,
    mitigating: `Many authorities will consider honest mistakes or unavoidable personal circumstances (e.g., childcare, disability, delays) as grounds for cancellation. Always explain fully and provide any evidence.`,
    other: `You have the right to a fair, transparent appeals process for any penalty charge or parking fine. Authorities must consider your evidence and follow legal procedure.`
  };

  function generatePDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const today = new Date().toLocaleDateString();
    const claimRef = `PARK-${new Date().toISOString().slice(0, 10).replace(/-/g, "")}-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
    let y = 20;

    doc.setFont("helvetica", "normal").setFontSize(12).setTextColor(0, 0, 0);
    doc.setFont(undefined, "bold").text(today, 10, y); y += 10;
    doc.setFont(undefined, "normal").text(`Appeal Reference: ${claimRef}`, 10, y); y += 10;
    doc.setFont(undefined, "bold").text("To:", 10, y); y += 6;
    doc.setFont(undefined, "normal").text(`${data.provider || ""}`, 10, y); y += 14;
    doc.setFont(undefined, "bold").text("Subject:", 10, y); y += 6;
    doc.setFont(undefined, "normal").text("Parking Fine/Penalty Charge Appeal", 10, y); y += 12;
    doc.setFont(undefined, "normal").text("Dear Sir/Madam,", 10, y); y += 10;

    const reasonText = data.claimType ? document.querySelector(`#claimType option[value="${data.claimType}"]`).textContent : "N/A";
    const intro = `I am writing to formally challenge the penalty charge/parking fine detailed below. My case relates to: ${reasonText.toLowerCase()}.`;
    const introLines = doc.splitTextToSize(intro, 180);
    doc.text(introLines, 10, y); y += introLines.length * 6 + 2;

    const legalText = legalJustification[data.claimType] || legalJustification.other;
    const legalLines = doc.splitTextToSize(legalText, 180);
    doc.setFont(undefined, "italic");
    doc.text(legalLines, 10, y); y += legalLines.length * 6 + 4;
    doc.setFont(undefined, "normal");

    doc.setFont(undefined, "bold").text("Ticket & Vehicle Details:", 10, y); y += 8;
    [
      `Full Name: ${data.fullName || ""}`,
      `PCN/Ticket Number: ${data.ticketNumber || ""}`,
      `Date Issued: ${data.dateIssued || ""}`,
      `Vehicle Registration: ${data.vehicleReg || ""}`,
      `Authority/Operator: ${data.provider || ""}`,
      `Reason for Appeal: ${reasonText}`,
      `Issue Description: ${data.issueDescription || ""}`
    ].forEach(line => { doc.text(line, 10, y); y += 7; });

    if (data.evidenceList && data.evidenceList.length > 0) {
      doc.setFont(undefined, "bold").text("Evidence Provided:", 10, y); y += 8;
      data.evidenceList.forEach(item => {
        doc.setFont(undefined, "normal").text("- " + item, 14, y); y += 7;
      });
      y += 2;
    }

    y += 2;
    doc.setFont(undefined, "bold").text("Preferred Contact Method:", 10, y); y += 7;
    doc.setFont(undefined, "normal").text(`${data.preferredContact || ""}`, 10, y); y += 10;

    const closing = `I ask you to review and cancel the penalty charge/fine on the basis of the above evidence and explanation. Please confirm receipt and your decision as soon as possible. I look forward to your response.`;
    const closingLines = doc.splitTextToSize(closing, 180);
    doc.text(closingLines, 10, y); y += closingLines.length * 6 + 2;

    doc.text("Thank you for your attention.", 10, y); y += 8;
    doc.text("Yours faithfully,", 10, y); y += 8;
    doc.text(data.fullName || "", 10, y); y += 8;

    const pageHeight = doc.internal.pageSize.getHeight();
    doc.setFontSize(10).setTextColor(120).text(
      "This document was generated at no cost by Quaerens.co.uk.",
      10,
      pageHeight - 10
    );

    doc.save(`Parking-Appeal-${data.ticketNumber || "unknown"}.pdf`);
  }

  function disableForm(form) {
    if (!form) return;
    [...form.elements].forEach(el => el.disabled = true);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    resultDiv.classList.add("hidden");

    // Gather fields
    const fullName = document.getElementById("fullName").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const ticketNumber = document.getElementById("ticketNumber").value.trim();
    const provider = document.getElementById("provider").value.trim();
    const dateIssued = document.getElementById("dateIssued").value;
    const vehicleReg = document.getElementById("vehicleReg").value.trim();
    const claimType = document.getElementById("claimType").value;
    const issueDescription = document.getElementById("issueDescription").value.trim();
    const preferredContact = document.getElementById("preferredContact").value;
    const donation = document.getElementById("donation").value;

    const evidenceEls = document.querySelectorAll('input[name="evidence"]:checked');
    const evidenceOtherText = document.getElementById('evidenceOtherText').value.trim();
    let evidenceList = Array.from(evidenceEls).map(el => el.value);
    if (evidenceList.includes("Other") && evidenceOtherText) {
      evidenceList[evidenceList.indexOf("Other")] = "Other: " + evidenceOtherText;
    }

    if (!fullName || !email || !provider || !claimType || !issueDescription) {
      alert("Please fill in all required fields marked with *.");
      return;
    }

    const claimData = {
      fullName, email, phone, ticketNumber, provider, dateIssued, vehicleReg,
      claimType, issueDescription, preferredContact, donation, evidenceList,
      createdAt: window.firebaseUtils ? serverTimestamp() : new Date().toISOString()
    };

    try {
      if (window.firebaseUtils && window.firebaseUtils.collection) await addDoc(collection(window.db, "parkingAppeals"), claimData);

      generatePDF(claimData);
      disableForm(form);
      let msg = "✅ Your appeal letter has been generated as a PDF. Please send it to your council or parking operator.<br><br>";
      if (evidenceList.length > 0) {
        msg += "<strong>Evidence you indicated:</strong><ul style='margin-left:1em'>";
        evidenceList.forEach(ev => msg += "<li>" + ev + "</li>");
        msg += "</ul><br>";
      }
      msg += "<strong>How to use your appeal letter:</strong><ol style='margin-left:1em'><li>Download and review your letter</li><li>Attach your evidence documents</li><li>Email or upload your letter and evidence to the appeals portal</li><li>Wait for a response (usually 2–4 weeks)</li></ol>";
      resultDiv.innerHTML = msg;
      resultDiv.classList.remove("hidden");

    } catch (err) {
      alert("Something went wrong while submitting your appeal. Please try again or contact support.");
    }
  });
});
</script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const otherCheckbox = document.getElementById('evidenceOtherCheckbox');
      const otherText = document.getElementById('evidenceOtherText');
      if (otherCheckbox) {
        otherCheckbox.addEventListener('change', function() {
          otherText.style.display = this.checked ? '' : 'none';
          if (!this.checked) otherText.value = '';
        });
      }
    });
  </script>
</body>
</html>